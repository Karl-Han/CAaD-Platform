<html>
  <head>
    <title>Sign up</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static "public/css/main.css" %}">
  </head>
  <body>
    {% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}
    <form id="doSignup" action="{% url "users:doSignup" %}" method="POST">
      {% csrf_token %}
      用户名: <input name="userName" id="uname"></input><p class="necessary">*</p></br>
      密码: <input name="password" type="password" id="pwd1"></input><p class="necessary">*</p></br>
      确认密码: <input name="password2" type="password" id="pwd2"></input><p class="necessary">*</p></br>
      电子邮箱: <input name="email" id="email"></input><p class="necessary">*</p></br>
      <!-- TODO: send an email for activating -->
      真实姓名: <input name="realName"></input></br>
      学号: <input name="uid"></input></br>
      <input type="submit" value="submit">
    </form>
    <a href="{% url "users:login" %}" id="login">登陆</a>

    <script type="text/javascript">
      window.addEventListener("load", function () {
        function sendData() {
          const necessary = {
            "uname": "用户名", 
            "pwd1": "密码", 
            "pwd2": "确认密码", 
            "email": "电子邮件"
          }
          for (const n in necessary) {
            var elem = document.getElementById(n);
            if (elem.value=="") {
              alert("带*的 "+necessary[n]+" 为必填项！");
              return;
            }
          }

          var pwd1 = document.getElementById("pwd1");
          var pwd2 = document.getElementById("pwd2");
          if (pwd1.value != pwd2.value) {
            alert("两次密码不一致！");
            return;
          }

          form = event.target;
          var url = form.action;
          var XHR = new XMLHttpRequest();
          var FD  = new FormData(form);
          XHR.onreadystatechange = function() {
            if (XHR.readyState==4 && XHR.status==200) {
              result = XHR.responseText.replaceAll("&quot;", "\"");
              result = JSON.parse(result);
              if (result["status"]) {
                if (result["status"] == 1) {
                  confirm("注册成功");
                  window.location.href = document.getElementById("login").href;
                } else {
                  alert("[Debug] "+result["reason"])  // TODO
                }

              } else {
                alert("[Debug] POST error");  // TODO
              }
            }
          }
          XHR.open("POST", url);
          XHR.send(FD);
        }

        var form = document.getElementById("doSignup");
        form.addEventListener("submit", function (event) {
          event.preventDefault();
          sendData();
        });
      });
    </script>
  </body>
</html>
